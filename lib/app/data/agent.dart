import 'dart:convert';
import 'package:http/http.dart' as http;
import 'package:il_env/app/modules/exam/controllers/exam_controller.dart';
import 'package:il_env/index.dart';
import 'package:google_generative_ai/google_generative_ai.dart';
import 'package:image_picker/image_picker.dart';
import 'package:mime/mime.dart';

enum ModelType { gemini, gpt }

abstract class ContentGenerator {
  final String apiKey;
  final String endpoint;
  final ModelType modelType;
  late final Map<String, String> headers;

  ContentGenerator(this.apiKey, this.modelType)
      : endpoint = modelType == ModelType.gemini
            ? 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=$apiKey'
            : 'https://api.openai.com/v1/chat/completions' {
    headers = {
      'Content-Type': 'application/json',
      if (modelType == ModelType.gpt) 'Authorization': 'Bearer $apiKey',
    };
  }

  Future<String> _sendRequest(Map<String, dynamic> payload) async {
    final response = await http.post(
      Uri.parse(endpoint),
      headers: headers,
      body: jsonEncode(payload),
    );

    if (response.statusCode != 200) {
      throw HttpException('Error: ${response.statusCode} - ${response.body}');
    }

    return _parseResponse(utf8.decode(response.bodyBytes));
  }

  String _parseResponse(String responseBody) {
    final data = jsonDecode(responseBody);
    return modelType == ModelType.gpt
        ? data['choices']?.first['message']['content'] ??
            'Error extracting content'
        : data['candidates']?.first['content']['parts']?.first['text'] ??
            'Error extracting content';
  }

  Future<String> generateContent(
      String systemInstruction, String content) async {
    final payload = _buildPayload(systemInstruction, content);
    return await _sendRequest(payload);
  }

  Map<String, dynamic> _buildPayload(String systemInstruction, String content) {
    return modelType == ModelType.gemini
        ? {
            "system_instruction": {
              "parts": {"text": systemInstruction}
            },
            "contents": {
              "parts": {"text": content}
            },
          }
        : {
            'model': 'gpt-4o-mini',
            'messages': [
              {'role': 'system', 'content': systemInstruction},
              {'role': 'user', 'content': content},
            ],
          };
  }
}

class ChatAgent extends ContentGenerator {
  ChatAgent(super.apiKey, super.modelType);

  Future<String> engageInChat(
      String systemInstruction, String userMessage) async {
    try {
      debugPrint('thinking...');
      final response = await generateContent(systemInstruction, userMessage);
      debugPrint(response);
      return response;
    } catch (e) {
      if (e is HttpException) {
        debugPrint('Chat error engageInChat(h): ${e.message}');
        errorSnackbar(TranslationKey.keyApiKeyError);
        Get.toNamed(Routes.SETTINGS);
        return '';
      } else {
        debugPrint('Chat error engageInChat(e): $e');
        errorSnackbar(TranslationKey.keyCheckConnection);
        return '';
      }
    }
  }
}

class HttpException implements Exception {
  final String message;
  HttpException(this.message);
}

class Agent {
  Future<String> initiateChat(
      String systemInstruction, String userMessage) async {
    try {
      final selectedModelType = await getSelectedModel();
      final apiKey = await getAPI(selectedModelType);
      if (apiKey.isEmpty || apiKey.length < 5) {
        errorSnackbar(TranslationKey.keyApiKeyError);
        Get.offAllNamed(Routes.HOME);
        Get.toNamed(Routes.SETTINGS);
        throw Exception('API key is empty');
      }

      final response = await ChatAgent(apiKey, selectedModelType)
          .engageInChat(systemInstruction, userMessage);

      return AgentUtils().cleanJson(response);
    } catch (e) {
      debugPrint('Agent error initiateChat: $e');
      return '';
    }
  }

  getAPI(ModelType selectedModelType) async {
    return await storage.read(key: selectedModelType.name) ??
        'AIzaSyDDGPyK8kwBGrWXuwUSlqlT2cw8U6XDVPE';
  }

  getSelectedModel() async {
    final savedModel = await storage.read(key: 'selectedModel');
    return savedModel == ModelType.gpt.name ? ModelType.gpt : ModelType.gemini;
  }
}

class AgentPrompts {
  String lessonKeysPrompt() => '''
ุงูุช ูููู ูููุฐุฌ ุฐูุงุก ุงุตุทูุงุนู ูุจูุฑ ูู ุชุทููุฑ IL-ENV ุงู ูุง ูุณูู ุจูุฆุฉ ุงูุชุนููู ุงูุฐููุฉ ููู ุชุทุจูู ุชุนูููู ููุณุงุนุฏุฉ ุงูุทูุงุจ ูุงู ุจุชุทููุฑู (ุตููุจ ุงูุทูุจ- Suhaib Eltayeb)

ูู ุจููู ุงููุต ุจุนูู ู ุชุญููู ุงูุฏุฑุณ ุฃู ุงูููุถูุน ุงููุญุฏุฏ ูุชุญุฏูุฏ ุงูุฃูุฏุงู ุงูุฑุฆูุณูุฉ ู ุงูููุงููู ุงูุฃุณุงุณูุฉ ูุงูููุงุท ุงููููุฉ ุงูุชู ูุฌุจ ุงูุชุฑููุฒ ุนูููุง ูุชุฎุฒูููุง ูู ูุชุบูุฑุงุช ููุงุณุจุฉ ุฏุงุฎู ุชูุณูู ุจุตูุบุฉ JSON.

# ุชูุงุตูู ุฅุถุงููุฉ

ูู ุจุชูููู ุงูุฏุฑุณ ุจุนููุ ูุฑูุฒ ุนูู ุงุณุชุฎุฑุงุฌ ุนูุงุตุฑ ุงููุนุฑูุฉ ุงูุชุงููุฉ:
- ุงูุฃูุฏุงู ุงูุฑุฆูุณูุฉ ููุฏุฑุณ: ูุง ุงูุฐู ูุฌุจ ุนูู ุงูุทูุงุจ ุจูุงูู ุฃู ุชุนููู ุจููุงูุฉ ุงูุฏุฑุณ.
- ุงูููุงููู ุงูุฃุณุงุณูุฉ: ุงูุฃููุงุฑ ุฃู ุงููุธุฑูุงุช ุงููููุฉ ุงูุชู ูุญุชุงุฌ ุงูุทูุงุจ ูููููุง.
- ุงูููุงุท ุงููููุฉ ุงูุชู ูุฌุจ ุงูุชุฑููุฒ ุนูููุง: ุงูุฃููุงุฑ ุงูุฃุณุงุณูุฉ ูุงูููุงุท ุงูุจุงุฑุฒุฉ ุฎูุงู ุงูุฏุฑุณ.


# ููุญูุธุงุช

- ูุฌุจ ุงูุชุฑููุฒ ุนูู ุงูุฏูุฉ ูุงููุถูุญ ูู ุชุญุฏูุฏ ุงูููุงุท ูุงูููุงููู.
- ุชุบุทูุฉ ุดุงููุฉ ููู ุนูุตุฑ ูุถูุงู ุฃู ุงูููุฎุต ูุนูุณ ูุนุงูู ุงูุฏุฑุณ ุจุดูู ูุงู.
- ุฃู ุชููู ุงูุฃูุฏุงู ูุงูููุงููู ูุงูููุงุท ูุญุฏุฏุฉ ุจูุถูุญ ููุฎุชุตุฑุฉ.
- ูู ุญุงู ุงุตุงุจู ุงููุต ุงูุฐู ูุชุจู ุงููุณุชุฎุฏู ุจุงู ููุน ูู ุงูุงุฑุจุงู ุงู ูุงู ุนุจุงุฑุฉ ุนู ุณูุงู ูู ูููููู ุนูู ููุถุน ุญูู ูุฐุง ุงูุณุคุงู ูุชุทุจูู ุนููู ุงูุนูุงุตุฑ ุงูุณุงุจูุฉ
- ุบูุฑ ูุณููุญ (ููููุน ููุนุง ุดุฏูุฏ ุงูููุฌุฉ) ุจุงูุฑุฏ ุจุฃู ุตูุบุฉ ุงุฎุฑู ุบูุฑ ุงูุตูุบุฉ ุงูููุฏูุฉ ูู ุงูุงุณูู ูุงู ุณุจุจ ูู ุงูุงุณุจุงุจ

ูุฌุจ ุฃู ูููู ุงููุฎุฑุฌ JSON ููุท  ููุง ููู:

{
    "summary": {
        "lesson_objectives": [
            "ูุฏู 1",
            "ูุฏู 2",
            "ูุฏู 3"
        ],
        "key_concepts": [
            "ููููู 1",
            "ููููู 2",
            "ููููู 3"
        ],
        "important_points": [
            "ููุทุฉ ูููุฉ 1",
            "ููุทุฉ ูููุฉ 2",
            "ููุทุฉ ูููุฉ 3"
        ]
    }
}



''';

  String lessonDividerPrompt() => '''
ุงูุช ูููู ูููุฐุฌ ุฐูุงุก ุงุตุทูุงุนู ูุจูุฑ ูู ุชุทููุฑ IL-ENV ุงู ูุง ูุณูู ุจูุฆุฉ ุงูุชุนููู ุงูุฐููุฉ ููู ุชุทุจูู ุชุนูููู ููุณุงุนุฏุฉ ุงูุทูุงุจ ูุงู ุจุชุทููุฑู (ุตููุจ ุงูุทูุจ- Suhaib Eltayeb)

ูู ุจุชูุณูู ุงููุต ุงูููุฏู ุฅูู ุฃุฌุฒุงุก ุฃู ููุฑุงุช ูููููุฉ ููุงุถุญุฉุ ูุงุญูุธ ูู ุฌุฒุก ูู ูุงุฆูุฉ. ูุฌุจ ุฃู ูุชุถูู ุงูุฅุฎุฑุงุฌ ุฌููุน ุงูุฃุฌุฒุงุก ุฏูู ุงุฎุชุตุงุฑ ุฃู ุชูุฎูุต. 
ุงุฐุง ูุงู ุงููุต ูุง ูุญุชูู ุนูู ุนูุงููู ูุซูุฑุฉ ุงูุดุฆ ุนูุงููู ุจุจุณุงุทุฉ ุชูุงุณุจ ูู ููุฑุฉ.
ุงูุบุฑุถ ูู ุนูููุฉ ุงูุชูุณูู ูู ูุณุงุนุฏุฉ ุงูุทูุงุจ ุนูู ููู ุงูุฏุฑุณ ุจุดูู ุงูุถูุ ูุฐูู ุงุญุฑุต ุนูู ุชุญููู ูุฐุง ุงููุฏู


# ููุงุญุธุงุช

- ุชุฃูุฏ ูู ุฃู ูู ุฌุฒุก ูุญุชูู ุนูู ุนููุงู ููุญุชูู.
- ูุฌุจ ุฃู ุชููู ุงูุฃุฌุฒุงุก ูููููุฉ ููุงุถุญุฉ.
- ูุง ุชุฎุชุตุฑ ุฃู ุชูุฎูุต ุงููุต.
- ุงูุงุฎุฑุงุฌ ูุฌุจ ุงู ูููู ุจุชูุณูู JSON ููุท ู ูุชููู ูู content_parts ุชุญุชูู ุนูู ูุงูุฉ ูู ุงูุงุฌุฒุงุก ุณุชุนุจุฑ t ุนู ุงูุนููุงู ู c ุนู ุงููุญุชูู
- ูุง ูุณูุญ ูู ุจุงุฎุชุตุงุฑ ุงููุญุชูู ุนููู ููุท ุชูุณููู ุงูู ุงุฌุฒุงุก ูุชุนุฏุฏุฉ

ูุฌุจ ุฃู ูููู ุงููุฎุฑุฌ JSON ููุท ููุง ููู:

{
    "content_parts": [
        {"t" : "ุนููุงู ุงูุฌุฒุก 1",
        "c":"ูุญุชูู ุงูุฌุฒุก 1"
        },
        {"t" : "ุนููุงู ุงูุฌุฒุก 2",
        "c":"ูุญุชูู ุงูุฌุฒุก 2"
        },
        {"t" : "ุนููุงู ุงูุฌุฒุก 3",
        "c":"ูุญุชูู ุงูุฌุฒุก 3"
        }
    ]
}
''';

  String deepExplanationPrompt(
          {String? oldExplanation, Map<String, dynamic>? part}) =>
      """
 ุงุดุฑุญ ุงููุต ุงูุชุงูู ุจุฃุณููุจ ูุฎุชูู:
    ุงูุชุฒู ุจุงููุนูููุงุช ุงููุชููุฑุฉ ูู ุงููุต
    ุนููุงู: ${part?['t']}
    ุงููุญุชูู: ${part?['c']}

    ุณุชูุฏู ุงูุดุฑุญ ุจุชูุณูู Markdown

    ูุฌุจ ุงู ูุฎุชูู ุนู ุดุฑุญู ุงูุณุงุจู ุจุญูุซ ูููู ุงุจุณุท ูุงุณูู ูู ุงูููู ู ููุธู ููุญุชูู ุนูู ุชุดุจููุงุช : $oldExplanation
ูููู ุงุณุชุฎุฏุงู ุฑููุฒ ุชุนุจูุฑูุฉ ุณูุจุญูุง ุงูุทูุงุจ ู ุชุณุงุนุฏูู ุนูู ุงูููู 
""";

  String exploreQuestionsPrompt(
          {List<dynamic>? oldQuestions, Map<String, dynamic>? part}) =>
      """
ูููุชู ูู ุงูุดุงุก ุงุณุฆูุฉ ุงุณุชูุดุงููุฉ ุชุณุงุนุฏ ุนูู ููู ุงููุญุชูู ุจุดูู ุงุนูู ูุน 
      ุงูุชุฒู ุจุงููุนูููุงุช ุงููุชููุฑุฉ ูู ุงููุต  
    ุนููุงู: ${part?['t']}
    ุงููุญุชูู: ${part?['c']}

    ุณุชูุฏู ุงูุงุณุฆูุฉ ุจุชูุณูู Markdown

    ูุฌุจ ุงู ุชุฎุชูู ุนู ุงูุฃุณุฆูุฉ ุงูุณุงุจูุฉ ุจุญูุซ ุงูุซุฑ ุนููุง : $oldQuestions
""";

  String directQuestionPrompt({Map<String, dynamic>? part}) => """
ุงูุช ูููู ูููุฐุฌ ุฐูุงุก ุงุตุทูุงุนู ูุจูุฑ ูู ุชุทููุฑ IL-ENV ุงู ูุง ูุณูู ุจูุฆุฉ ุงูุชุนููู ุงูุฐููุฉ ููู ุชุทุจูู ุชุนูููู ููุณุงุนุฏุฉ ุงูุทูุงุจ ูุงู ุจุชุทููุฑู (ุตููุจ ุงูุทูุจ- Suhaib Eltayeb)

    ุนููุงู: ${part?['t']}
    ุงููุญุชูู: ${part?['c']}

ูู ุงูุบุงูุจ ุณูููู ุณุคุงู ุงูุทูุงุจ ูู ุนูุงูุฉ ุจุงููุญุชูู ุงูุณุงุจู
""";

  String makerQuestionsPrompt() => """
ูู ุจุฅูุดุงุก ูุฌููุนุฉ ูู ุงูุฃุณุฆูุฉ ุจูุงุกู ุนูู ุงููุต ุงูููุฏู. ูุฌุจ ุฃู ุชููู ุงูุฃุณุฆูุฉ ูุงุถุญุฉ ููุฑุชุจุฉ ุญุณุจ ุงูููุน. ุฅุฐุง ูุงู ุงููุต ูุญุชูู ุนูู ูุนูููุงุช ุชุญุชุงุฌ ูุชูุณูุฑ ุฃู ุงุณุชูุชุงุฌุ ููููู ุชุถููู ุฃุณุฆูุฉ ุชููู ูุฏู ููู ุงูุทุงูุจ ูููุญุชูู.

ููุงุญุธุงุช:
ุชุฃูุฏ ูู ุชูุณูู ุงูุฃุณุฆูุฉ ุจุดูู ูุชูุงุณุจ ูุน ููุน ุงูุณุคุงู (ุตุญูุญ/ุฎุทุฃ ุฃู ุงุฎุชูุงุฑุงุช ูุชุนุฏุฏุฉ).
ููู ุณุคุงู ูุฌุจ ุฃู ูููู ูุฏูู ูุต ุงูุณุคุงูุ ุฎูุงุฑุงุช ุงูุฅุฌุงุจุฉุ ุงูุฌูุงุจ ุงูุตุญูุญุ ูููุน ุงูุณุคุงู.
ุงูุฃุณุฆูุฉ ูุฌุจ ุฃู ุชุดูู ุชุบุทูุฉ ูุฃุฌุฒุงุก ูุฎุชููุฉ ูู ุงููุต.
ูุฌุจ ุชุญุฏูุฏ ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ ุจูุถูุญ.
ุนุฏุฏ ุงูุงุณุฆูุฉ ูุฌุจ ุฃู ูููู ูุง ุจูู 10 ุงูู 18 
ูููุน ูุชุงุจุฉ ุงุณุฆูุฉ ุงู ุงุฌุงุจุงุช ุฎุงุฑุฌ ูุทุงู ุงูุฏุฑุณ


ูุฌุจ ุฃู ูููู ุงููุฎุฑุฌ JSON ููุท ููุง ููู:
ูุง ุชุณุชุฎุฏู " ุจูู ุงููุตูุต ูุชูุงุฏู ุญุฏูุซ ุญุทุงุก ุนูุฏ ุชุญููู ุงูุฑุฏ ุงูุฎุงุต ุจู ุงูู JSON ููููู ุงุณุชุฎุฏุงู ุฌููุน ุงูุนูุงูุงุช ุงูุชู ูุง ุชุชุนุงุฑุถ ูุน JSON

{
  "questions": [
    {
      "questionText": "ูุต ุงูุณุคุงู ุงูุซุงูู ููุง",
      "options": ["ุตุญูุญ", "ุฎุทุฃ"],
      "correctAnswer": "ุตุญูุญ",
      "questionType": "trueFalse"
    },
    {
      "questionText": "ูุต ุงูุณุคุงู ููุง",
      "options": ["ุงูุฎูุงุฑ 1", "ุงูุฎูุงุฑ 2", "ุงูุฎูุงุฑ 3", "ุงูุฎูุงุฑ 4"],
      "correctAnswer": "ุงูุฎูุงุฑ ุงูุตุญูุญ",
      "questionType": "multipleChoice"
    }
  ]
}

""";

  String overallEvaluationPrompt(String lesson) => '''

ูู ุจุชูุฏูู ุชูููู ุดุงูู ูุฃุฏุงุก ุงูุทุงูุจ ุจูุงุกู ุนูู ุฏุฑุฌุชู ูู ุงูุงุฎุชุจุงุฑ ููุชุงุฆุฌ ุฅุฌุงุจุงุชูุ ูุน ุงูุชุฑููุฒ ุนูู ุงูุฌูุงูุจ ุงูุฅูุฌุงุจูุฉ ูุงููุฌุงูุงุช ุงูุชู ุชุญุชุงุฌ ูุชุญุณูู.

# ุฎุทูุงุช ุงูุชูููู

1. ุงุจุฏุฃ ุจุชูุฏูู ุชูููู ุฅูุฌุงุจู ุดุงูู ูู ุณุทุฑูู ุนู ุฃุฏุงุก ุงูุทุงูุจ ูู ูุฐุง ุงูุงุฎุชุจุงุฑุ ูุตูู ูุง ูุงู ุจุฃุฏุงุฆู ุจุดูู ุฌูุฏ ููุง ูููู ุชุญุณููู.
2. ุงุฐูุฑ ุงูุฏุฑุฌุฉ ุงูุชู ุญุตู ุนูููุง ุงูุทุงูุจ ุจุดูู ูุงุถุญ.
3. ุงุนุฑุถ ุชูุงุตูู ุงูุฃุณุฆูุฉ ูุงูุฅุฌุงุจุงุช ููู ูุง ููู:
   - ุงูุณุคุงู: [ูุต ุงูุณุคุงู]
   - ุฅุฌุงุจุฉ ุงูุทุงูุจ: ุฅุฐุง ูุงูุช ุงูุฅุฌุงุจุฉ `null`ุ ูุฏููุง ููุฐุง: `[ูู ุชุฌุจ]`
   - ุงูุชุญูู: [ุตุญ / ุฎุทุฃ]
     - ุฅุฐุง ูุงูุช ุงูุฅุฌุงุจุฉ ุฎุทุฃุ ุฃุถู ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ ูุนุฑู ุงูุทุงูุจ ุจูุง.
4. ุญุฏุฏ ููุงุท ุงูุถุนู ุงูุชู ูุฌุจ ุนูู ุงูุทุงูุจ ุงูุนูู ุนูููุง ู ูุฑุงุฌุนุชูุง.
5. ูุฏู ูุตูุญุฉ ูุญุฏุฏุฉ ููุณุงุนุฏุฉ ุงูุทุงูุจ ุนูู ุงูุชุญุณู (ูุซู ุงูุชุฑููุฒ ุนูู ููุงุท ุถุนู ูุนููุฉุ ุฃู ุงุณุชุฎุฏุงู ุทุฑู ูุนููุฉ ููุฏุฑุงุณุฉ).
6. ุญุฏุฏ ูุง ุฅุฐุง ูุงู ุงูุทุงูุจ ูุญุชุงุฌ ููุฑุงุฌุนุฉ ุงูุฏุฑุณ ุจุงููุงูู ุฃู ุฌุฒุก ูุนููุ ุฃู ุฅุฐุง ููููู ุงูุงูุชูุงู ููุฏุฑุณ ุงูุชุงูู.

# ุชุนูููุงุช ุงูุชูุงุตู

- ุงุณุชุฎุฏู ุฃุณููุจ ุงููุฎุงุทุจุฉ ุงููุจุงุดุฑุฉุ ูุชุญุฏุซ ููุทุงูุจ ุจุดูู ูุฑุฏู.
- ุงุณุชุฎุฏู ุถูุงุฆุฑ ูุซู "ุฃูุช"ุ "ุฃูุตูู"ุ ู "ูุตูุญุชู ูู".
- ุชุฌูุจ ุงุณุชุฎุฏุงู ุชุนุจูุฑุงุช ูุซู "ุงูุทุงูุจ"ุ ููู ูุฏูุฏุงู ููุนุฒุฒุงู ููุซูุฉ ุจุงูููุณ.

# Output Format (Example) :

### ๐ ุชูููู ุดุงูู:
**ุฃุญุณูุช ุนูู ุฃุฏุงุฆู ุงูุฌูุฏ ูู ุงูุฃุณุฆูุฉ ุงููุชุนููุฉ ุจุงูููุงููู ุงูุฃุณุงุณูุฉุ ูููู ููุงู ุญุงุฌุฉ ููุฒูุฏ ูู ุงูุชุฑููุฒ ุนูู ุงูุฃุณุฆูุฉ ุงูุชุทุจูููุฉ.**

**ูุนุฏู ุงูุทุงูุจ**: 70% (ุฃุฌุจุช ุนูู 7 ูู 10)

---

### ๐ ุชูุงุตูู ุงูุฃุณุฆูุฉ ูุงูุฅุฌุงุจุงุช:
1. **ุงูุณุคุงู**: ูุง ูู ุนุงุตูุฉ ุงููุงุจุงูุ  
   **ุฅุฌุงุจุฉ ุงูุทุงูุจ**: ุทูููู  
   **ุงูุชุญูู**: โ ุตุญ

2. **ุงูุณุคุงู**: ูุง ูู ูุฑุจุน ุงูุนุฏุฏ 5ุ  
   **ุฅุฌุงุจุฉ ุงูุทุงูุจ**: 10  
   **ุงูุชุญูู**: โ ุฎุทุฃ (ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ: 25)

---

### โ๏ธ ููุงุท ุงูุถุนู:
- ุงูุนูููุงุช ุงูุญุณุงุจูุฉ ุงููุชุนููุฉ ุจุงููุฑุจุนุงุช.

---

### ๐ก ูุตูุญุฉ:
- ุฃูุตูู ุจูุฑุงุฌุนุฉ ุงูุนุจุงุฑุงุช ุงูุญุณุงุจูุฉ ุงูุฃุณุงุณูุฉ ุจุดูู ุฃูุจุฑุ ุฎุงุตุฉ ุงูููุงููู ุงููุชุนููุฉ ุจุงููุฑุจุนุงุช.

---

### ๐ ุฎุทุฉ ุงููุฑุงุฌุนุฉ:
- ูุญุชุงุฌ ุงูุทุงูุจ ุฅูู ูุฑุงุฌุนุฉ ุงูุฌุฒุก ุงูุฎุงุต ุจุงูุนูููุงุช ุงูุญุณุงุจูุฉ ููุท.



**ููุงุญุธุฉ**:
- ูุฌุจ ุฃู ุชุชููู ุงูุชุนูููุงุช ูุงููุตุงุฆุญ ูุน ูุณุชูู ุงูุทุงูุจ ุงูุญุงูู ูุฃุฏุงุฆู.
- ุงุฐุง ูุงู ูุฏู ุงูุทุงูุจ ูุดุงูู ูุจูุฑุฉ ูู ุงูุญูุธ ุงูุตุญู ุจุงูุชูุงุฌู ุงูู ูุณู ุจุทุงูุงุช ุงูุญูุธ (ุจุทุงูุงุช ููุงุด) ุณุชุณุงุนุฏุฉ ุนูู ุงูุญูุธ ู ุงูุงุณุชุฐูุงุฑ

ุจุฅููุงูู ุงุณุชุฎุฏุงู ุงูููุฌู ู ุฑููุฒ ุชุนุจูุฑูุฉ ุงุฐุง ุงุญุชุฌุช

ูุฐุง ูู ุงูุฏุฑุณ : $lesson
''';

  String weaknessesPrompt(List<Question> questions, String lesson) => '''
ุงูุช ูููู ูููุฐุฌ ุฐูุงุก ุงุตุทูุงุนู ูุจูุฑ ู ูุนูู ุฐูู ููุทูุงุจ ูู ุชุทููุฑ IL-ENV ุงู ูุง ูุณูู ุจูุฆุฉ ุงูุชุนููู ุงูุฐููุฉ ููู ุชุทุจูู ุชุนูููู ููุณุงุนุฏุฉ ุงูุทูุงุจ ูุงู ุจุชุทููุฑู (ุตููุจ ุงูุทูุจ- Suhaib Eltayeb)

ุญุฏุฏ ููุงุท ุงูุถุนู ูู ุฃุฏุงุก ุงูุทุงูุจ ุจูุงุกู ุนูู ุฅุฌุงุจุงุชู ุนูู ุงูุฃุณุฆูุฉ ูุงูุฏุฑุณ.

ุงูุฃุณุฆูุฉ:
${questions.map((q) => ':ุงูุณูุงู ${q.questionText}: ุงูุงุฌุงุจุฉ ุงูุตุญูุญุฉ : ${q.correctAnswer} ุงุฌุงุจุฉ ุงูุทุงูุจ ${q.studentAnswer}').join('\n')}

ุงูุฏุฑุณ:
$lesson

ูุฌุจ ุฃู ูููู ุงููุฎุฑุฌ ูุตูุง ูููุณููุง ุจุดูู ุฌูุฏุ ูุน ุชุญุฏูุฏ ููุงุท ุงูุถุนู ุจุฏูุฉ ููุถูุญ ููุฑุงุฌุนุชูุง ุณุฑูุนุง ูุน ุงูุทุงูุจ .
''';

  String advicePrompt(List<Question> questions, String lesson) => '''
ุงูุช ูููู ูููุฐุฌ ุฐูุงุก ุงุตุทูุงุนู ูุจูุฑ ู ูุนูู ุฐูู ููุทูุงุจ ูู ุชุทููุฑ IL-ENV ุงู ูุง ูุณูู ุจูุฆุฉ ุงูุชุนููู ุงูุฐููุฉ ููู ุชุทุจูู ุชุนูููู ููุณุงุนุฏุฉ ุงูุทูุงุจ ูุงู ุจุชุทููุฑู (ุตููุจ ุงูุทูุจ- Suhaib Eltayeb)

ูุฏู ุจุนุถ ุงููุตุงุฆุญ ููุทุงูุจ ูุชุญุณูู ุฃุฏุงุฆู ุจูุงุกู ุนูู ุฅุฌุงุจุงุชู ุนูู ุงูุฃุณุฆูุฉ ูุงูุฏุฑุณ.

ุงูุฃุณุฆูุฉ:
${questions.map((q) => ':ุงูุณูุงู ${q.questionText}: ุงูุงุฌุงุจุฉ ุงูุตุญูุญุฉ : ${q.correctAnswer} ุงุฌุงุจุฉ ุงูุทุงูุจ ${q.studentAnswer}').join('\n')}

ุงูุฏุฑุณ:
$lesson

ูุฌุจ ุฃู ุชููู ุงููุตุงุฆุญ ููููุฏุฉ ูููุดุฌุนุฉุ ูุน ุงูุชุฑููุฒ ุนูู ุงูุฌูุงูุจ ุงูุชู ูุญุชุงุฌ ุงูุทุงูุจ ูุชุญุณูููุง ูู ุงูุฏุฑุณ.  ูุฌุจ ุฃู ูููู ุงููุฎุฑุฌ ูุตูุง ูููุณููุง ุจุดูู ุฌูุฏ.
ุงุฌุนู ุงุฌุงุจุชู ููุฌุฒุฉ ูุฏุฑ ุงูุงููุงู
''';

  String generateFlashcardsPrompt(String lessonContent) => '''
ุงูุช ูููู ูููุฐุฌ ุฐูุงุก ุงุตุทูุงุนู ูุจูุฑ ูู ุชุทููุฑ IL-ENV ุงู ูุง ูุณูู ุจูุฆุฉ ุงูุชุนููู ุงูุฐููุฉ ููู ุชุทุจูู ุชุนูููู ููุณุงุนุฏุฉ ุงูุทูุงุจ ูุงู ุจุชุทููุฑู (ุตููุจ ุงูุทูุจ- Suhaib Eltayeb)

ูู ุจุชูููุฏ ุจุทุงูุงุช ุญูุธ (Flashcards) ุจูุงุกู ุนูู ูุญุชูู ุงูุฏุฑุณ ุงูุชุงูู ุงูุชุฒู ุจุงููุต ุงูููุฌูุฏ ูู ุงููุญุชูู:

$lessonContent

ูุฌุจ ุฃู ุชููู ูู ุจุทุงูุฉ ุญูุธ ุนุจุงุฑุฉ ุนู ุฒูุฌ ูู ุงูุณุคุงู ูุงูุฅุฌุงุจุฉ.  ูุฌุจ ุฃู ูููู ุงููุฎุฑุฌ ุจุชูุณูู JSONุ ุญูุซ ูุญุชูู ูู ุนูุตุฑ ุนูู "question" ู "answer".

ูุฌุจ ุฃู ูููู ุงููุฎุฑุฌ JSON ููุท ููุง ููู:

```json
[
  {"question": "ุงูุณุคุงู ุงูุฃูู", "answer": "ุงูุฅุฌุงุจุฉ ุงูุฃููู"},
  {"question": "ุงูุณุคุงู ุงูุซุงูู", "answer": "ุงูุฅุฌุงุจุฉ ุงูุซุงููุฉ"},
  {"question": "ุงูุณุคุงู ุงูุซุงูุซ", "answer": "ุงูุฅุฌุงุจุฉ ุงูุซุงูุซุฉ"}
]
```
''';

//TODO (1): ุฏุงูุฉ prompt ุชุงุฎุฐ ุงูุฏุฑุณ ู ุชููุฏ ุงูุจุทุงูุงุช ุจุชูุณูู json
}

class AgentUtils {
  String cleanJson(String input) {
    final regex = RegExp(r'```json\s*(.*?)\s*```', dotAll: true);
    final match = regex.firstMatch(input);

    if (match != null && match.groupCount > 0) {
      return match.group(1)!.trim(); // ุงุณุชุฎุฏู ุงููุฌููุนุฉ ุงูุฃููู
    } else {
      return input; // ุฅุฐุง ูู ูุชู ุงูุนุซูุฑ ุนูู JSONุ ุฃุนุฏ ุงููุต ููุง ูู
    }
  }

  String formatObjectivesAsMarkdown(dynamic objectives) {
    StringBuffer markdown = StringBuffer();

    for (var objective in objectives) {
      markdown.writeln('- $objective');
    }

    return markdown.toString();
  }
}



Future<String?> extractTextFromImage(XFile? imageFile) async {
  try {
    if (imageFile == null) {
      return null;
    }

    final imageBytes = await imageFile.readAsBytes();

    final mimeType = lookupMimeType(imageFile.path) ?? 'image/jpeg';

    final apiKey = await Agent().getAPI(ModelType.gemini);
    if (apiKey == null) {
          debugPrint('ุฎุทุงุก ูู extractTextFromImage() : apiKey');

      return null;
    }

    final model = GenerativeModel(model: 'gemini-1.5-flash', apiKey: apiKey);

    final content = Content.multi([
      TextPart('ุงุณุชุฎุฑุฌ ุงููุต ูู ูุฐู ุงูุตูุฑุฉ.'),
      DataPart(mimeType, imageBytes),
    ]);

    final response = await model.generateContent([content]);
    return response.text;
  } catch (e) {
    debugPrint('ุฎุทุงุก ูู extractTextFromImage(): $e');
    return null;
  }
}
